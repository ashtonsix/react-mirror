{"version":3,"file":"index.js","sources":["src/cursor/cursor_naive.js","src/utils/createCursorAPI.js","src/utils/generateStoreId.js","src/utils/Enum.js","src/utils/streams/combine.js","src/utils/streams/filterUnchanged.js","src/backend/backend.js","src/backend/index.js","src/utils/shallowEqual.js","src/bindings/react.js","src/utils/streams/combineActionsWith.js","src/utils/streams/combineNested.js","src/utils/streams/combineSimple.js","src/index.js"],"sourcesContent":["const traverse = (tree, onVisit) => {\r\n  const q = [tree]\r\n\r\n  while (q.length) {\r\n    const node = q.shift()\r\n    q.push(...node.children)\r\n    onVisit(node)\r\n  }\r\n}\r\n\r\nconst getChildren = node => {\r\n  const children = []\r\n  traverse(node, node => children.push(node))\r\n  return children\r\n}\r\n\r\nconst getParents = node => {\r\n  const parents = []\r\n  while (node.parent) {\r\n    node = node.parent\r\n    parents.push(node)\r\n  }\r\n  return parents\r\n}\r\n\r\nconst testFilter = (node, filter) => {\r\n  if (\r\n    !filter ||\r\n    filter === node.id ||\r\n    filter === node.component ||\r\n    node.name.includes(filter)\r\n  ) {\r\n    return true\r\n  }\r\n  return false\r\n}\r\n\r\nconst runQuery = (tree, originIds, query) => {\r\n  if (!query.length) return originIds\r\n\r\n  let operator\r\n  ;[operator, ...query] = query\r\n\r\n  if (operator.op === 'root') return runQuery(tree, [tree.id], query)\r\n\r\n  const originNodes = []\r\n  traverse(tree, node => {\r\n    if (originIds.includes(node.id)) {\r\n      originNodes.push(node)\r\n    }\r\n  })\r\n\r\n  const result = (() => {\r\n    let result = originNodes.map(node => {\r\n      const getMatches = operator.op === 'children' ? getChildren : getParents\r\n      let matches = getMatches(node)\r\n      matches = matches.filter(node => testFilter(node, operator.filter))\r\n      matches = matches.slice(0, operator.maxStores)\r\n      matches = matches.map(node => node.id)\r\n      return matches\r\n    })\r\n    result = [].concat(...result)\r\n    result = Array.from(new Set(result))\r\n    return result\r\n  })()\r\n\r\n  return runQuery(tree, result, query.slice(1))\r\n}\r\n\r\nconst createCursorBackend = () => {\r\n  let prevTree\r\n\r\n  return {\r\n    query(origin, query) {\r\n      runQuery(prevTree, [origin], query)\r\n    },\r\n    updateNode(tree, op) {\r\n      prevTree = tree\r\n      const results = {}\r\n      traverse(tree, node => {\r\n        results[node.id] = node.queries.map(query => {\r\n          return runQuery(tree, [node.id], query)\r\n        })\r\n      })\r\n      return results\r\n    }\r\n  }\r\n}\r\n\r\nexport default createCursorBackend\r\n","const createCursorAPI = (enhancer, query = {}) => {\r\n  const cursorMethods = {\r\n    root() {\r\n      query = [{op: 'root'}]\r\n      return createCursorAPI(cursorMethods, query)\r\n    },\r\n    parents(filter = null, maxStores = Infinity) {\r\n      query = query.concat({op: 'parents', filter, maxStores})\r\n      return createCursorAPI(cursorMethods, query)\r\n    },\r\n    children(filter = null, maxStores = Infinity) {\r\n      query = query.concat({op: 'children', filter, maxStores})\r\n      return createCursorAPI(cursorMethods, query)\r\n    },\r\n    all(filter = null, maxStores = Infinity) {\r\n      query = [{op: 'root'}, {op: 'children', filter, maxStores}]\r\n      return createCursorAPI(cursorMethods, query)\r\n    },\r\n    one(filter = null) {\r\n      query = [{op: 'root'}, {op: 'children', filter, maxStores: 1}]\r\n      return createCursorAPI(cursorMethods, query)\r\n    },\r\n    parent(filter = null) {\r\n      query = query.concat({op: 'parents', filter, maxStores: 1})\r\n      return createCursorAPI(cursorMethods, query)\r\n    }\r\n  }\r\n  return enhancer(cursorMethods, query)\r\n}\r\n\r\nexport default createCursorAPI\r\n","/*\r\n  Store ids should:\r\n\r\n    * Be easy to read / recognise\r\n    * Not conflict with filters\r\n    * Communicate how many components have been mounted during session\r\n*/\r\nconst ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'\r\n\r\nconst counter = [0, -1]\r\n\r\nconst generateStoreId = () => {\r\n  for (let i = counter.length - 1; i >= 0; i--) {\r\n    if (counter[i] === 25) {\r\n      counter[i] = 0\r\n      if (!i) counter.unshift(0)\r\n    } else {\r\n      counter[i] += 1\r\n      break\r\n    }\r\n  }\r\n  return counter.map(char => ALPHABET[char]).join('')\r\n}\r\n\r\nexport const couldBeStoreId = RegExp.prototype.test.bind(/^[A-Z]{2,12}$/)\r\n\r\nexport default generateStoreId\r\n","class Enum extends Array {\r\n  constructor(obj) {\r\n    const keys = Object.keys(obj)\r\n    const values = keys.map(key => obj[key])\r\n    super(...values)\r\n    this.keys = keys\r\n    keys.forEach(key => (this[key] = obj[key]))\r\n  }\r\n  map(f) {\r\n    const obj = {}\r\n    this.forEach(function map(value, index, key, arr) {\r\n      obj[key] = f(value, index, key, arr)\r\n    })\r\n    return new Enum(obj)\r\n  }\r\n  filter(f) {\r\n    const obj = {}\r\n    this.forEach(function filter(value, index, key, arr) {\r\n      if (f(value, index, key, arr)) {\r\n        obj[key] = value\r\n      }\r\n    })\r\n    return new Enum(obj)\r\n  }\r\n  forEach(f) {\r\n    return super.forEach(function forEach(value, index, arr) {\r\n      return f(value, index, this.keys[index], arr)\r\n    })\r\n  }\r\n  every(f) {\r\n    return super.every(function every(value, index, arr) {\r\n      return f(value, index, this.keys[index], arr)\r\n    })\r\n  }\r\n  find(f) {\r\n    return super.find(function find(value, index, arr) {\r\n      return f(value, index, this.keys[index], arr)\r\n    })\r\n  }\r\n  findIndex(f) {\r\n    return super.findIndex(function findIndex(value, index, arr) {\r\n      return f(value, index, this.keys[index], arr)\r\n    })\r\n  }\r\n  some(f) {\r\n    return super.some(function some(value, index, arr) {\r\n      return f(value, index, this.keys[index], arr)\r\n    })\r\n  }\r\n  reduce(f) {\r\n    return super.reduce(function reduce(prev, value, index, arr) {\r\n      return f(prev, value, index, this.keys[index], arr)\r\n    })\r\n  }\r\n  reduceRight(f) {\r\n    return super.reduceRight(function reduceRight(prev, value, index, arr) {\r\n      return f(prev, value, index, this.keys[index], arr)\r\n    })\r\n  }\r\n}\r\n\r\nexport default Enum\r\n","import * as most from 'most'\r\nimport Enum from '../Enum'\r\n\r\nconst combine = (...streams) => {\r\n  return most.combine((...enumCollection) => {\r\n    const result = {}\r\n    enumCollection.forEach(_enum_ => {\r\n      _enum_.forEach((value, i, key) => {\r\n        result[key] = value\r\n      })\r\n    })\r\n    return new Enum(result)\r\n  }, ...streams)\r\n}\r\n\r\nexport default combine\r\n","const SKIP_TOKEN = '__MIRROR_SKIP_TOKEN__'\r\n\r\nconst filterUnchanged = (equalityCheck, $stream) => {\r\n  return $stream\r\n    .loop((prevValue, value) => {\r\n      const isEqual = equalityCheck(prevValue, value)\r\n      if (isEqual) return {seed: value, value: SKIP_TOKEN}\r\n      return {seed: value, value}\r\n    }, undefined)\r\n    .filter(value => value !== SKIP_TOKEN)\r\n}\r\n\r\nconst keyArrayEqual = ({oldKeyArray, oldKeySet}, keyArray) => {\r\n  if (oldKeyArray === keyArray) return true\r\n\r\n  for (let i in keyArray) {\r\n    if (!oldKeySet.has(keyArray[i])) return false\r\n  }\r\n\r\n  return keyArray.length === oldKeyArray.length\r\n}\r\n\r\nexport const filterUnchangedKeyArrays = $stream => {\r\n  return $stream\r\n    .loop(\r\n      (seed, keyArray) => {\r\n        let isEqual = keyArrayEqual(seed, keyArray)\r\n        if (isEqual) return {seed, value: SKIP_TOKEN}\r\n        return {\r\n          seed: {oldKeyArray: keyArray, oldKeySet: new Set(keyArray)},\r\n          value: keyArray\r\n        }\r\n      },\r\n      {oldKeyArray: [], oldKeySet: new Set()}\r\n    )\r\n    .filter(value => value !== SKIP_TOKEN)\r\n}\r\n\r\nexport default filterUnchanged\r\n","import * as most from 'most'\r\nimport createCursorBackend from '../cursor'\r\nimport createCursorAPI from '../utils/createCursorAPI'\r\nimport generateStoreId, {couldBeStoreId} from '../utils/generateStoreId'\r\nimport combine from '../utils/streams/combine'\r\nimport {filterUnchangedKeyArrays} from '../utils/streams/filterUnchanged'\r\n\r\nconst createMirrorBackend = () => {\r\n  let root\r\n  const storeMap = {}\r\n  const cursorBackend = createCursorBackend()\r\n\r\n  let onStoreUpdated\r\n  function* storeUpdatedGenerator() {\r\n    const f = resolve => (onStoreUpdated = resolve)\r\n    while (true) {\r\n      yield new Promise(f)\r\n    }\r\n  }\r\n\r\n  const $queryResults = most.from(storeUpdatedGenerator).map(({store, op}) => {\r\n    if (op === 'add') storeMap[store.id] = store\r\n    if (op === 'remove') delete storeMap[store.id]\r\n    return cursorBackend.updateNode(root, {path: store.path, op})\r\n  })\r\n\r\n  const updateStore = (store, {requesting, streams, identifiers = [], metadata = {}}) => {\r\n    Object.assign(store, {identifiers, metadata})\r\n\r\n    if (identifiers.some(couldBeStoreId)) {\r\n      // warning()\r\n    }\r\n\r\n    const $storeDeleted = $queryResults.filter(() => !storeMap[store.id])\r\n\r\n    let ADD_STREAMS_ASYNC\r\n\r\n    store.mirror = createCursorAPI((cursorMethods, query) => {\r\n      const cursor = {}\r\n      requesting.concat('$actions').forEach(streamName => {\r\n        Object.defineProperty(cursor, streamName, {\r\n          get() {\r\n            const queryIndex = store.queries.length\r\n            store.queries.push(query)\r\n            if (ADD_STREAMS_ASYNC) {\r\n              onStoreUpdated({store, op: 'update'})\r\n            }\r\n\r\n            return $queryResults\r\n              .map(queryResults => queryResults[store.id][queryIndex])\r\n              .thru(filterUnchangedKeyArrays)\r\n              .map(stores => {\r\n                return (streamName === '$actions' ? most.mergeArray : combine)(\r\n                  stores\r\n                    .map(id => {\r\n                      if (id === store.id && query.length && streamName === '$state') {\r\n                        return undefined\r\n                      }\r\n                      return storeMap[id] && storeMap[id].streams[streamName]\r\n                    })\r\n                    .filter(s => s)\r\n                )\r\n              })\r\n              .switchLatest()\r\n          }\r\n        })\r\n      })\r\n      Object.defineProperty(cursor, '$stores', {\r\n        get() {\r\n          return $queryResults\r\n            .map(() => ({\r\n              cursor: cursorBackend.query(store.id, query),\r\n              store\r\n            }))\r\n            .until($storeDeleted)\r\n        }\r\n      })\r\n      Object.assign(cursor, cursorMethods)\r\n      return cursor\r\n    })\r\n\r\n    store.dispatch = createCursorAPI((cursorMethods, query) => {\r\n      const dispatch = (type, payload, retryIfSelectionEmpty = true) => {\r\n        if (!store.id) return // warning()\r\n        const stores = cursorBackend.query(store.id, query)\r\n        if (stores.length || !retryIfSelectionEmpty) {\r\n          stores.forEach(id => {\r\n            storeMap[id].dispatch(type, payload)\r\n          })\r\n          return\r\n        }\r\n\r\n        $queryResults\r\n          .until(\r\n            $storeDeleted.tap(() => {\r\n              // warning()\r\n            })\r\n          )\r\n          .map(() => cursorBackend.query(store.id, query))\r\n          .filter(stores => stores.length)\r\n          .take(1)\r\n          .observe(stores => {\r\n            stores.forEach(id => {\r\n              storeMap[id].dispatch(type, payload)\r\n            })\r\n          })\r\n      }\r\n      Object.assign(dispatch, cursorMethods)\r\n      return dispatch\r\n    })\r\n\r\n    if (!store.streams.$actions) {\r\n      function* actionGenerator() {\r\n        while (true) {\r\n          yield new Promise(resolve => (store.dispatch = resolve))\r\n        }\r\n      }\r\n      store.streams.$actions = most.from(actionGenerator).until($storeDeleted)\r\n    }\r\n\r\n    if (streams) {\r\n      const $actions = store.streams.$actions\r\n      store.streams = streams(store.mirror, store.dispatch)\r\n      store.streams.$actions = $actions\r\n    }\r\n\r\n    ADD_STREAMS_ASYNC = true\r\n  }\r\n\r\n  const backend = {\r\n    addStore(parentId, {requesting, streams, identifiers, metadata}) {\r\n      if (!parentId) parentId = root && root.id\r\n      const parent = storeMap[parentId]\r\n      if (!parent && root) return // warning()\r\n\r\n      const store = {\r\n        id: generateStoreId(),\r\n        path: root ? parent.path.concat(parentId) : [],\r\n        streams: {},\r\n        queries: [],\r\n        children: {},\r\n        parent\r\n      }\r\n\r\n      if (store.parent) store.parent.children[store.id] = store\r\n\r\n      updateStore(store, {requesting, streams, identifiers, metadata})\r\n      onStoreUpdated({store, op: 'add'})\r\n      store.dispatch('INITIALIZE')\r\n\r\n      return store\r\n    },\r\n    removeStore(storeId) {\r\n      const store = storeMap[storeId]\r\n      if (!store) return // warning()\r\n      if (store === root) return // warning()\r\n\r\n      const traverse = store => {\r\n        store.children.forEach(traverse)\r\n        // TODO: test dispatch in response to TEARDOWN\r\n        store.dispatch('TEARDOWN')\r\n        onStoreUpdated({store, op: 'remove'})\r\n      }\r\n      traverse(store)\r\n\r\n      if (store && store.parent) {\r\n        delete store.parent.children[storeId]\r\n      }\r\n    },\r\n    updateStore(storeId, {requesting, streams, identifiers, metadata}) {\r\n      const store = storeMap[storeId]\r\n      if (!store) return // warning()\r\n\r\n      updateStore(store, {requesting, streams, identifiers, metadata})\r\n      onStoreUpdated({store, op: 'update'})\r\n\r\n      return store\r\n    }\r\n  }\r\n\r\n  root = backend.addStore(null, {metadata: {root: true}})\r\n\r\n  return backend\r\n}\r\n\r\nexport default createMirrorBackend\r\n","import createMirrorBackend from './backend'\r\n\r\nconst MirrorBackend = createMirrorBackend()\r\n\r\nexport default MirrorBackend\r\n","const hasOwn = Object.prototype.hasOwnProperty\r\n\r\nconst shallowEqual = (a, b) => {\r\n  if (a === b) return true\r\n\r\n  let countA = 0\r\n  let countB = 0\r\n\r\n  for (let key in a) {\r\n    if (hasOwn.call(a, key) && a[key] !== b[key]) return false\r\n    countA++\r\n  }\r\n\r\n  for (let key in b) {\r\n    if (hasOwn.call(b, key)) countB++\r\n  }\r\n\r\n  return countA === countB\r\n}\r\n\r\nexport default shallowEqual\r\n","import * as most from 'most'\r\nimport React from 'react'\r\nimport MirrorBackend from '../backend'\r\nimport shallowEqual from '../utils/shallowEqual'\r\nimport filterUnchanged from '../utils/streams/filterUnchanged'\r\n\r\nconst instantiseMapToProps = mapToProps => {\r\n  let CALLED_ONCE\r\n  const instantisedMapToProps = (state, props) => {\r\n    let result = mapToProps(state, props)\r\n    if (!CALLED_ONCE && typeof result === 'function') {\r\n      mapToProps = result\r\n      result = mapToProps(state, props)\r\n    }\r\n    CALLED_ONCE = true\r\n    return result\r\n  }\r\n  return instantisedMapToProps\r\n}\r\n\r\nfunction createMirrorDecorator(config = {}) {\r\n  return function decorateWithMirror(WrappedComponent) {\r\n    let {name = [], state, mapToProps, pure} = config\r\n    if (!(name instanceof Array)) name = [name]\r\n    if (typeof mapToProps !== 'function') {\r\n      mapToProps = (state, props) => ({...props, ...state})\r\n    }\r\n    if (!pure) pure = {propsEqual() {}, stateEqual() {}, propsStateEqual() {}}\r\n    if (pure === true) pure = {}\r\n    Object.assign(\r\n      {\r\n        propsEqual: shallowEqual,\r\n        shallowEqual: shallowEqual,\r\n        propsStateEqual: shallowEqual\r\n      },\r\n      pure\r\n    )\r\n\r\n    if (!WrappedComponent) {\r\n      WrappedComponent = function Noop() {\r\n        return null\r\n      }\r\n    }\r\n\r\n    class Mirror extends React.Component {\r\n      constructor(props, context) {\r\n        super()\r\n        this.state = {updateCount: 0, props: undefined}\r\n\r\n        this.propsRecievedGenerator = function*() {\r\n          while (true) {\r\n            yield new Promise(resolve => (this.onReceivedProps = resolve))\r\n          }\r\n        }\r\n        const $stateEnd = most.from(new Promise(resolve => (this.onStateEnd = resolve)))\r\n\r\n        const {id, mirror, dispatch, streams} = MirrorBackend.addStore(context.id, {\r\n          requesting: ['$state', '$props'],\r\n          identifiers: [...config.name, Mirror.__COMPONENT_IDENTIFIER__],\r\n          streams: (mirror, dispatch) => {\r\n            const $props = filterUnchanged(\r\n              pure.propsEqual.bind(this),\r\n              most.from(this.propsRecievedGenerator)\r\n            )\r\n            if (!state) return {$props}\r\n            let $state = filterUnchanged(pure.stateEqual.bind(this)).until(\r\n              $stateEnd,\r\n              state.call(this, mirror, dispatch)\r\n            )\r\n            return {$state, $props}\r\n          },\r\n          metadata: {\r\n            instance: this\r\n          }\r\n        })\r\n        Object.assign(this, {id, mirror, dispatch})\r\n\r\n        filterUnchanged(\r\n          pure.propsStateEqual.bind(this),\r\n          most.combine(\r\n            instantiseMapToProps(mapToProps).bind(this),\r\n            streams.$state,\r\n            streams.$props\r\n          )\r\n        ).observe(propsState => {\r\n          this.setState(({updateCount}) => ({updateCount: updateCount + 1, propsState}))\r\n        })\r\n      }\r\n      getWrappedInstance() {\r\n        return this.wrappedInstance\r\n      }\r\n      getChildContext() {\r\n        return {id: this.id}\r\n      }\r\n      componentWillReceiveProps(nextProps) {\r\n        this.onReceivedProps(nextProps)\r\n      }\r\n      shouldComponentUpdate(nextProps, nextState) {\r\n        return nextState.updateCount > this.state.updateCount\r\n      }\r\n      componentWillUnmount() {\r\n        this.propsRecievedGenerator.return()\r\n        this.onStateEnd()\r\n        MirrorBackend.removeStore(this.id)\r\n      }\r\n      render() {\r\n        if (this.state.updateCount === 0 && config.state) {\r\n          return null\r\n        }\r\n\r\n        return React.createElement(WrappedComponent, {\r\n          ...this.state.props,\r\n          ref: ref => (this.wrappedInstance = ref),\r\n          dispatch: this.dispatch\r\n        })\r\n      }\r\n    }\r\n\r\n    const _name = WrappedComponent.displayName || WrappedComponent.name || 'Component'\r\n    Mirror.displayName = `Mirror(${_name})`\r\n    Mirror.contextTypes = {id() {}}\r\n    Mirror.childContextTypes = {id() {}}\r\n    Mirror.__COMPONENT_IDENTIFIER__ = Mirror\r\n\r\n    const createStaticCursors = () => {\r\n      delete Mirror.mirror\r\n      delete Mirror.dispatch\r\n      if (Mirror !== Mirror.__COMPONENT_IDENTIFIER__) {\r\n        Mirror.mirror = Mirror.__COMPONENT_IDENTIFIER__.mirror\r\n        Mirror.dispatch = Mirror.__COMPONENT_IDENTIFIER__.dispatch\r\n        return\r\n      }\r\n\r\n      const {mirror, dispatch} = MirrorBackend.addStore(null, {\r\n        identifiers: ['MIRROR/static', `MIRROR/static/${_name}`],\r\n        metadata: {\r\n          static: Mirror\r\n        }\r\n      })\r\n\r\n      Object.assign(Mirror, {\r\n        mirror: mirror.all(Mirror),\r\n        dispatch: dispatch.all(Mirror)\r\n      })\r\n    }\r\n\r\n    Object.defineProperties(Mirror, {\r\n      mirror: {get: () => (createStaticCursors(), Mirror.mirror)},\r\n      dispatch: {get: () => (createStaticCursors(), Mirror.dispatch)}\r\n    })\r\n\r\n    Mirror.__WITH_NAME_CACHE__ = {}\r\n    const withNameCache = Mirror.__COMPONENT_IDENTIFIER__.__WITH_NAME_CACHE__\r\n    Mirror.withName = function withName(...name) {\r\n      name = [].concat(...name, config.name).sort()\r\n      const key = JSON.stringify(name) // TODO: support non-string names\r\n      if (withNameCache[key]) return withNameCache[key]\r\n\r\n      const renamedComponent = createMirrorDecorator({...config, name})(WrappedComponent)\r\n      renamedComponent.__COMPONENT_IDENTIFIER__ = Mirror.__COMPONENT_IDENTIFIER__\r\n      withNameCache[key] = renamedComponent\r\n    }\r\n\r\n    return Mirror\r\n  }\r\n}\r\n\r\nexport default createMirrorDecorator\r\n","import * as most from 'most'\r\n\r\nconst SKIP_TOKEN = '__MIRROR_SKIP_TOKEN__'\r\n\r\nconst combineActionsWithDefault = (actionStream, otherStream) => {\r\n  return most\r\n    .combine((action, other) => ({action, other}))\r\n    .loop(\r\n      ({prevAction, before}, {action, other: after}) => ({\r\n        seed: {\r\n          prevAction: action,\r\n          before: prevAction === action ? SKIP_TOKEN : after\r\n        },\r\n        value: before === SKIP_TOKEN ? {before, action, after} : SKIP_TOKEN\r\n      }),\r\n      {}\r\n    )\r\n    .filter(value => value !== SKIP_TOKEN)\r\n}\r\n\r\nconst combineActionsWithBefore = (actionStream, otherStream) => {\r\n  return actionStream.sample((action, other) => ({before: other, action}), otherStream)\r\n}\r\n\r\nconst combineActionsWithAfter = (actionStream, otherStream) => {\r\n  return combineActionsWithDefault(actionStream, otherStream).map(value => {\r\n    delete value.before\r\n    return value\r\n  })\r\n}\r\n\r\nconst combineActionsWithNothing = actionStream => {\r\n  return actionStream.map(action => ({action}))\r\n}\r\n\r\nconst combineActionsWith = (\r\n  actionStream,\r\n  otherStream,\r\n  options = {before: true, after: true}\r\n) => {\r\n  if (options.before && options.after) {\r\n    return combineActionsWithDefault(actionStream, otherStream)\r\n  } else if (options.before) {\r\n    return combineActionsWithBefore(actionStream, otherStream)\r\n  } else if (options.after) {\r\n    return combineActionsWithAfter(actionStream, otherStream)\r\n  }\r\n\r\n  return combineActionsWithNothing(actionStream)\r\n}\r\n\r\nexport default combineActionsWith\r\n","import * as most from 'most'\r\nimport Enum from '../Enum'\r\n\r\nconst combineNested = streamMap => {\r\n  const keys = Object.keys(streamMap)\r\n  const streams = keys.map(key => streamMap[key])\r\n  return most.combine((...enumCollection) => {\r\n    const result = {}\r\n    enumCollection.forEach(_enum_ => {\r\n      _enum_.forEach((value, i, key) => {\r\n        if (!result[key]) result[key] = result[key]\r\n        result[key][keys[i]] = value\r\n      })\r\n    })\r\n    return new Enum(result)\r\n  }, ...streams)\r\n}\r\n\r\nexport default combineNested\r\n","import * as most from 'most'\r\n\r\nconst combineSimple = most.combine.bind(null, (...values) => [...values])\r\n\r\nexport default combineSimple\r\n","import MirrorBackend from './backend'\r\nimport Mirror from './bindings'\r\nimport combine from './utils/streams/combine'\r\nimport combineActionsWith from './utils/streams/combineActionsWith'\r\nimport combineNested from './utils/streams/combineNested'\r\nimport combineSimple from './utils/streams/combineSimple'\r\n\r\nconst {addStore, removeStore, updateStore} = MirrorBackend\r\n\r\nexport {addStore, removeStore, updateStore}\r\nexport {combine, combineActionsWith, combineNested, combineSimple}\r\nexport default Mirror\r\n"],"names":["traverse","tree","onVisit","q","length","node","shift","push","children","getChildren","getParents","parents","parent","testFilter","filter","id","component","name","includes","runQuery","originIds","query","operator","op","originNodes","result","map","getMatches","matches","slice","maxStores","concat","Array","from","Set","createCursorBackend","prevTree","origin","results","queries","createCursorAPI","enhancer","cursorMethods","Infinity","ALPHABET","counter","generateStoreId","i","unshift","char","join","couldBeStoreId","RegExp","prototype","test","bind","Enum","obj","keys","Object","values","key","forEach","f","value","index","arr","every","find","findIndex","some","reduce","prev","reduceRight","combine","streams","most","enumCollection","SKIP_TOKEN","filterUnchanged","equalityCheck","$stream","loop","prevValue","isEqual","seed","undefined","keyArrayEqual","keyArray","oldKeyArray","oldKeySet","has","filterUnchangedKeyArrays","createMirrorBackend","storeUpdatedGenerator","root","storeMap","cursorBackend","onStoreUpdated","resolve","Promise","$queryResults","store","updateNode","path","updateStore","requesting","identifiers","metadata","assign","$storeDeleted","ADD_STREAMS_ASYNC","mirror","cursor","defineProperty","streamName","queryIndex","queryResults","thru","stores","s","switchLatest","until","dispatch","type","payload","retryIfSelectionEmpty","tap","take","observe","$actions","actionGenerator","backend","parentId","storeId","addStore","MirrorBackend","hasOwn","hasOwnProperty","shallowEqual","a","b","countA","countB","call","instantiseMapToProps","CALLED_ONCE","instantisedMapToProps","state","props","mapToProps","createMirrorDecorator","config","decorateWithMirror","WrappedComponent","pure","Noop","Mirror","context","updateCount","propsRecievedGenerator","onReceivedProps","$stateEnd","onStateEnd","__COMPONENT_IDENTIFIER__","$props","propsEqual","$state","stateEqual","propsStateEqual","setState","propsState","wrappedInstance","nextProps","nextState","return","removeStore","React","createElement","ref","Component","_name","displayName","contextTypes","childContextTypes","createStaticCursors","all","defineProperties","get","__WITH_NAME_CACHE__","withNameCache","withName","sort","JSON","stringify","renamedComponent","combineActionsWithDefault","actionStream","otherStream","action","other","prevAction","before","after","combineActionsWithBefore","sample","combineActionsWithAfter","combineActionsWithNothing","combineActionsWith","options","combineNested","streamMap","combineSimple"],"mappings":"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"}